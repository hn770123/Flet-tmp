# Fletを使ったWindowsアプリ開発のベストプラクティス

Fletを使ったWindowsアプリ開発、特にexe化せずポータブルに配布する場合のベストプラクティスをまとめました。企業利用を想定し、セキュリティや法務面での考慮点も記載しています。

## 1. プロジェクト構成のベストプラクティス

Fletアプリケーションのコードが大きくなっても管理しやすいよう、以下のような構成を推奨します。MVVM（Model-View-ViewModel）に近い構成を取ることで、ロジックとUIを分離しやすくなります。

```
my_flet_app/
├── assets/                 # 画像、フォントなどの静的ファイル
│   └── logo.png
├── src/                    # ソースコードのルート
│   ├── __init__.py
│   ├── main.py             # エントリーポイント
│   ├── app.py              # アプリケーションの初期化・設定
│   ├── views/              # 各画面の定義
│   │   ├── __init__.py
│   │   ├── home_view.py
│   │   └── settings_view.py
│   ├── components/         # 再利用可能なUIコンポーネント
│   │   ├── __init__.py
│   │   └── custom_button.py
│   ├── models/             # データモデル・ビジネスロジック
│   │   ├── __init__.py
│   │   └── user_model.py
│   └── utils/              # ユーティリティ関数
│       ├── __init__.py
│       └── config.py
├── tests/                  # テストコード
├── README.md
└── requirements.txt        # 依存ライブラリ一覧
```

### ポイント
- **`main.py`**: アプリケーションのエントリーポイントとして、`flet.app(target=main)` の呼び出しのみを行います。
- **`views/`**: 画面（ページ）ごとにファイルを分割します。
- **`components/`**: 共通で使用するボタンやカードなどのUI部品をまとめます。
- **`models/`**: データの保持やビジネスロジック（計算処理など）を記述し、UIから切り離します。
- **`assets/`**: 画像ファイルなどはここに配置し、コード内からは相対パスや `assets_dir` 指定で参照します。

## 2. Windowsポータブル環境の構築（インストール不要・exe化なし）

「インストール不要」かつ「exe化しない」要件を満たすため、Pythonの **Embedded Distribution** を使用する方法がベストです。これにより、Python環境ごとフォルダにまとめて配布できます。

### 手順

1.  **Python Embedded Distributionの準備**
    - [Python公式サイト](https://www.python.org/downloads/windows/)から "Windows embeddable package (64-bit)" をダウンロードし、解凍します（例: `python-3.12.x-embed-amd64`）。

2.  **pipの導入**
    - 解凍したフォルダ内の `python3xx._pth` ファイルを開き、`import site` の行のコメントアウト（`#`）を外します。
    - [get-pip.py](https://bootstrap.pypa.io/get-pip.py) をダウンロードし、フォルダ内に配置します。
    - コマンドプロンプトでフォルダに移動し、`python.exe get-pip.py` を実行してpipをインストールします。

3.  **Fletのインストール**
    - 同じフォルダ内で `python.exe -m pip install flet` を実行します。
    - **注意**: バージョンによっては、`pip install` 時に必要なバイナリが含まれますが、環境によっては初回起動時に追加コンポーネントのダウンロードが発生する場合があります。配布前に一度、開発環境（またはこのEmbedded環境）でアプリを起動し、オフラインで動作することを確認してください。

4.  **アプリの配置**
    - `src` フォルダや `assets` フォルダを、Pythonフォルダ内（または隣接するフォルダ）に配置します。

5.  **起動スクリプトの作成**
    - ユーザーがワンクリックで起動できるよう、バッチファイル（`start_app.bat`）を作成します。

    ```batch
    @echo off
    cd /d %~dp0
    rem Pythonのパスを指定して実行
    python-3.12.x-embed-amd64\python.exe src\main.py
    ```

これで、このフォルダ一式をコピーするだけで、PythonがインストールされていないWindows環境でも動作します。

## 3. 企業利用における懸念点（法務・セキュリティ）

企業で導入する際に問題となりやすいポイントと対策です。

### 法務・ライセンス

*   **Fletのライセンス**: [Apache License 2.0](https://github.com/flet-dev/flet/blob/main/LICENSE) です。商用利用、修正、配布が可能ですが、著作権表示（Licenseファイルの同梱）が必要です。
*   **依存ライブラリのライセンス**:
    *   **Python**: Python Software Foundation License（商用利用可、GPL互換）。
    *   **Flutter Engine**: Fletは内部でFlutterを使用しています。Flutterは [BSD-style license](https://github.com/flutter/engine/blob/main/LICENSE) です（商用利用可）。
    *   その他 `pip` でインストールしたライブラリのライセンスも確認し、`LICENSE` ファイル等を同梱して配布するのが安全です。

### セキュリティ

*   **ローカルサーバーの起動**:
    *   Flet（デスクトップ版）は、内部的にローカルWebサーバーを立ち上げ、WebSocketで通信を行います（通常はランダムなポートを使用）。
    *   **懸念**: 企業のセキュリティソフト（EDRやファイアウォール）が「未知のプロセスがポートをリッスンしている」としてブロックしたり、警告を出したりする可能性があります。
    *   **対策**: 開発段階で情シス部門に確認するか、署名済みのバイナリを使用する（ただしexe化しない場合はPython自体の署名に依存）。
*   **ソースコードの保護**:
    *   exe化せずPythonスクリプトのまま配布するため、**ソースコードは誰でも閲覧・改変が可能**です。
    *   **懸念**: APIキーやデータベースのパスワードなどの機密情報をコード内にハードコードしてはいけません。
    *   **対策**:
        *   機密情報はサーバーサイドに持たせ、API経由で取得する。
        *   どうしても隠したいロジックがある場合は、Cythonでコンパイルしてバイナリ化（`.pyd`）するか、PyArmorなどの難読化ツールを検討する。
*   **インターネット接続**:
    *   Fletアプリは、構成によっては初回起動時にバイナリをダウンロードしようとする場合があります。
    *   **懸念**: プロキシ環境下やオフライン環境では起動に失敗します。
    *   **対策**: 手順3で触れた通り、配布パッケージ作成時にインターネット接続なしで起動できることを必ず検証してください。

### その他

*   **ファイルパスの扱い**:
    *   Windowsのパス長制限（260文字）に引っかからないよう、フォルダ階層を深くしすぎないように注意してください。
    *   ユーザー権限で書き込みできない場所（`C:\Program Files` 等）に置かれる可能性があるため、ログや設定ファイルは `app_data` ディレクトリ（`%APPDATA%`）に保存するように実装してください。

---
以上が、Fletを用いたWindowsアプリ開発のベストプラクティスです。
