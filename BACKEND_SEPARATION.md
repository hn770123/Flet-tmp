# バックエンド分離とサーバー稼働の手順（Flet Webアプリ方式）

Fletはクライアント・サーバーアーキテクチャを採用しており、標準機能としてWebアプリケーションとして動作させるモードを備えています。これを利用することで、バックエンド（Pythonロジック・DB操作）をサーバー上で実行し、フロントエンド（UI）をユーザーのブラウザに表示させることができます。

この方法では、別途REST API（FastAPIなど）を構築したり、クライアント側でHTTPリクエストを実装したりする必要がなく、既存のコードベースをほぼそのまま利用できるため、最も効率的な分離・移行手順となります。

---

## 1. 「Webアプリケーションとして動作させるモード」とは

FletアプリケーションをWebモードで実行すると、以下のようなアーキテクチャになります。

### 1.1. サーバーサイド (Python)
*   **場所**: Linuxサーバーなどのリモート環境。
*   **役割**: アプリケーションの状態管理、ビジネスロジックの実行、データベース操作などをすべて担当します。
*   **動作**: Pythonプロセスが常駐し、クライアントからの接続を待ち受けます。ユーザーがボタンを押すなどの操作をすると、イベントがサーバーに送信され、Pythonの関数が実行されます。その結果としてUIの変更が必要な場合、サーバーからクライアントへ更新命令が送られます。

### 1.2. クライアントサイド (Webブラウザ)
*   **場所**: ユーザーのPCやスマートフォンのWebブラウザ（Chrome, Safariなど）。
*   **役割**: UIの描画とユーザー入力の受付のみを行います。Pythonコードは一切実行されません。
*   **動作**: サーバーから送られてきたUI定義（Flutterベース）を描画します。FletのJavaScriptクライアントが裏で動作し、サーバーと常に通信を行っています。

### 1.3. 通信 (WebSocket)
*   サーバーとクライアントの間は **WebSocket** で常時接続されます。これにより、リアルタイムな双方向通信が可能になります。
*   例えば、サーバー側で `page.add(Text("Hello"))` を実行すると、その命令がWebSocketを通じて即座にブラウザに届き、画面上にテキストが表示されます。
*   この仕組みのおかげで、開発者は「サーバーと通信する」という意識を持つことなく、ローカルアプリと同じ感覚でコードを書くことができます。

---

## 2. 必要なライブラリのインストール

サーバーとして動作させるために、Web関連の機能（FastAPI, Uvicornなど）を含む `flet-web` が必要です。

```bash
pip install "flet[web]" uvicorn
```

※ `flet[web]` をインストールすることで、必要な `flet-web` パッケージもインストールされます。

`requirements.txt` には以下のように記述してください。

```txt
flet
flet-web
uvicorn
```

※ 環境によっては `flet-web` を明示的に記述しないとエラーになる場合があるため、推奨されます。

---

## 3. 実行方法（開発・簡易テスト）

最も簡単な方法は、FletのCLIツールを使用してWebモードで起動することです。コードの変更は不要です。

```bash
# プロジェクトのルートディレクトリで実行
flet run --web --port 8000 --host 0.0.0.0 main.py
```

*   `--web`: Webアプリとして起動します。
*   `--port 8000`: 8000番ポートを使用します（必要に応じて変更）。
*   `--host 0.0.0.0`: 外部からの接続を受け付けます。

これで、ブラウザから `http://<サーバーのIPアドレス>:8000` にアクセスすると、アプリケーションが利用できます。

---

## 4. 実行方法（本番環境・Uvicorn使用）

本番環境では、より堅牢なASGIサーバーである `uvicorn` を使用することをお勧めします。そのためには、ASGIアプリケーションオブジェクトをエクスポートする小さなラッパースクリプトを作成します。

### 4.1. `asgi.py` の作成

プロジェクトのルートディレクトリに `asgi.py` を作成します。

```python
# asgi.py
import flet as ft
from main import main  # 既存のmain関数をインポート

# ASGIアプリケーションの作成
app = ft.app(main, export_asgi_app=True)
```

### 4.2. サーバーの起動

`uvicorn` コマンドを使ってサーバーを起動します。

```bash
uvicorn asgi:app --host 0.0.0.0 --port 8000
```

*   `asgi:app`: `asgi.py` ファイル内の `app` オブジェクトを指定しています。

---

## 5. 注意事項

*   **ステート管理**: Fletはセッションごとに独立した状態を持ちますが、グローバル変数などを使うと全ユーザーで共有されてしまう可能性があります。データベース以外の状態管理には注意してください。
*   **データベース**: `sqlite3` はサーバー上のローカルファイルを使用するため、すべてのユーザーが同じデータベースを参照します（これが意図した動作です）。
*   **セキュリティ**: インターネット公開する場合は、HTTPS化（SSL/TLS）を前段のWebサーバー（Nginxなど）で行うことを強く推奨します。

この方式により、バックエンドロジックのサーバー集約と、クライアントへのUI配信が、Fletの標準機能だけで実現できます。
